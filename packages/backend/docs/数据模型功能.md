# 数据模型功能

## 概述

数据模型功能是DevAPI Manager项目中的核心模块之一，专门用于管理和维护项目的数据库表结构。该功能支持通过AI解析数据库设计文档，自动生成数据模型，并提供完整的CRUD操作界面。

## 功能特性

### 1. 数据模型管理
- **数据表管理**：创建、查看、更新、删除数据库表定义
- **字段管理**：定义表字段类型、长度、约束条件等
- **索引管理**：管理表索引，支持主键、唯一键、普通索引等
- **表关系管理**：定义表之间的外键关系

### 2. AI文档解析
- **智能解析**：支持Markdown格式的数据库设计文档
- **多格式支持**：支持SQL DDL、表格形式的字段定义
- **批量导入**：一次性解析并创建多个数据表
- **错误处理**：完善的解析错误提示和处理机制

### 3. 数据验证
- **类型验证**：支持多种数据库字段类型验证
- **约束检查**：主键、外键、唯一性约束检查
- **命名规范**：表名、字段名命名规范检查

## 技术架构

### 数据库设计

#### 核心表结构

1. **database_tables** - 数据库表信息
   ```sql
   CREATE TABLE database_tables (
     id            STRING PRIMARY KEY,
     project_id    STRING NOT NULL,
     name          STRING NOT NULL,
     display_name  STRING,
     comment       STRING,
     engine        STRING DEFAULT 'InnoDB',
     charset       STRING DEFAULT 'utf8mb4',
     collation     STRING DEFAULT 'utf8mb4_unicode_ci',
     status        STRING DEFAULT 'DRAFT',
     category      STRING,
     created_at    DATETIME DEFAULT CURRENT_TIMESTAMP,
     updated_at    DATETIME DEFAULT CURRENT_TIMESTAMP
   );
   ```

2. **database_fields** - 表字段信息
   ```sql
   CREATE TABLE database_fields (
     id                  STRING PRIMARY KEY,
     table_id           STRING NOT NULL,
     name               STRING NOT NULL,
     type               STRING NOT NULL,
     length             INTEGER,
     precision          INTEGER,
     scale              INTEGER,
     nullable           BOOLEAN DEFAULT TRUE,
     default_value      STRING,
     comment            STRING,
     is_primary_key     BOOLEAN DEFAULT FALSE,
     is_auto_increment  BOOLEAN DEFAULT FALSE,
     enum_values        STRING, -- JSON格式
     referenced_table_id STRING,
     referenced_field_id STRING,
     sort_order         INTEGER DEFAULT 0,
     created_at         DATETIME DEFAULT CURRENT_TIMESTAMP,
     updated_at         DATETIME DEFAULT CURRENT_TIMESTAMP
   );
   ```

3. **database_indexes** - 表索引信息
   ```sql
   CREATE TABLE database_indexes (
     id         STRING PRIMARY KEY,
     table_id   STRING NOT NULL,
     name       STRING NOT NULL,
     type       STRING DEFAULT 'INDEX',
     fields     STRING NOT NULL, -- JSON数组
     is_unique  BOOLEAN DEFAULT FALSE,
     comment    STRING,
     created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
     updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
   );
   ```

4. **table_relationships** - 表关系信息
   ```sql
   CREATE TABLE table_relationships (
     id               STRING PRIMARY KEY,
     from_table_id    STRING NOT NULL,
     to_table_id      STRING NOT NULL,
     from_field_id    STRING NOT NULL,
     to_field_id      STRING NOT NULL,
     relationship_type STRING DEFAULT 'ONE_TO_MANY',
     name             STRING,
     description      STRING,
     created_at       DATETIME DEFAULT CURRENT_TIMESTAMP,
     updated_at       DATETIME DEFAULT CURRENT_TIMESTAMP
   );
   ```

5. **data_model_documents** - 导入文档记录
   ```sql
   CREATE TABLE data_model_documents (
     id           STRING PRIMARY KEY,
     project_id   STRING NOT NULL,
     name         STRING NOT NULL,
     description  STRING,
     file_path    STRING,
     content      STRING NOT NULL,
     parse_status STRING DEFAULT 'PENDING',
     parse_error  STRING,
     language     STRING DEFAULT 'markdown',
     imported_at  DATETIME DEFAULT CURRENT_TIMESTAMP,
     created_at   DATETIME DEFAULT CURRENT_TIMESTAMP,
     updated_at   DATETIME DEFAULT CURRENT_TIMESTAMP
   );
   ```

### 后端API设计

#### RESTful接口

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /api/v1/data-models | 获取数据表列表 |
| POST | /api/v1/data-models | 创建数据表 |
| GET | /api/v1/data-models/:id | 获取数据表详情 |
| PUT | /api/v1/data-models/:id | 更新数据表 |
| DELETE | /api/v1/data-models/:id | 删除数据表 |
| POST | /api/v1/data-models/batch | 批量创建数据表 |

#### 请求/响应格式

**创建数据表**
```json
POST /api/v1/data-models
{
  "projectId": "uuid",
  "name": "users",
  "displayName": "用户表",
  "comment": "存储用户基础信息",
  "engine": "InnoDB",
  "charset": "utf8mb4",
  "status": "DRAFT",
  "category": "用户系统"
}
```

**批量创建数据表**
```json
POST /api/v1/data-models/batch
{
  "tables": [
    {
      "projectId": "uuid",
      "name": "users",
      "displayName": "用户表",
      "comment": "用户基础信息"
    },
    {
      "projectId": "uuid", 
      "name": "orders",
      "displayName": "订单表",
      "comment": "订单信息"
    }
  ]
}
```

### 前端界面设计

#### 主要组件

1. **数据模型列表页**：显示项目下所有数据表
2. **数据表详情页**：显示表结构、字段、索引信息
3. **导入向导**：AI文档解析和导入流程
4. **表编辑器**：可视化编辑表结构

#### 状态管理

使用React Query进行数据状态管理：

```typescript
// 获取数据表列表
const { data: dataTablesData } = useQuery({
  queryKey: ['dataTables', projectId],
  queryFn: () => apiMethods.getDataTables({ projectId })
})

// 批量创建数据表
const createTablesMutation = useMutation({
  mutationFn: apiMethods.createBatchDataTables,
  onSuccess: () => {
    queryClient.invalidateQueries(['dataTables'])
  }
})
```

## AI文档解析流程

### 解析支持的格式

1. **Markdown表格格式**
   ```markdown
   ## 用户表 (users)
   
   | 字段名 | 类型 | 长度 | 主键 | 非空 | 注释 |
   |--------|------|------|------|------|------|
   | id | BIGINT | 20 | YES | YES | 用户ID |
   | username | VARCHAR | 50 | NO | YES | 用户名 |
   ```

2. **SQL DDL格式**
   ```sql
   CREATE TABLE users (
     id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
     username VARCHAR(50) NOT NULL COMMENT '用户名',
     email VARCHAR(100) NOT NULL COMMENT '邮箱'
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
   ```

### 解析流程

1. **文档预处理**：清理格式，分块处理
2. **模式识别**：识别表定义、字段定义模式
3. **结构提取**：提取表名、字段信息、约束条件
4. **数据验证**：验证数据类型、命名规范
5. **结果生成**：生成标准化的数据模型对象

### AI服务配置

支持多种AI服务提供商：

- **Ollama本地服务**：qwen2.5-coder模型
- **DeepSeek在线服务**：deepseek-coder模型
- **OpenAI服务**：gpt-3.5-turbo模型

## 使用场景

### 1. 项目初期设计
- 导入数据库设计文档
- 快速生成数据模型
- 团队协作和评审

### 2. 数据库重构
- 现有表结构导入
- 结构对比和版本管理
- 迁移方案制定

### 3. 文档生成
- 自动生成数据字典
- 导出设计文档
- API文档联动

## 最佳实践

### 1. 命名规范
- 表名使用小写字母和下划线
- 字段名保持一致的命名风格
- 添加有意义的注释

### 2. 数据类型选择
- 根据数据范围选择合适的整型
- 字符串字段预留适当长度
- 时间字段使用标准格式

### 3. 索引设计
- 主键和外键自动创建索引
- 查询频繁的字段添加索引
- 避免过多不必要的索引

## 扩展功能

### 计划中的功能

1. **版本控制**：数据模型版本管理和历史记录
2. **迁移脚本**：自动生成数据库迁移脚本
3. **实体关系图**：可视化展示表关系
4. **代码生成**：根据数据模型生成ORM代码
5. **数据同步**：与实际数据库结构同步

### 集成能力

- **API生成**：根据数据模型自动生成CRUD API
- **前端生成**：生成数据表格和表单组件
- **文档联动**：数据模型与API文档关联

## 技术栈

- **后端**：Node.js + Express + TypeScript + Prisma
- **数据库**：SQLite (支持PostgreSQL、MySQL扩展)
- **前端**：React + TypeScript + TanStack Query
- **AI服务**：Ollama/DeepSeek/OpenAI
- **文档解析**：自定义解析器 + AI辅助

## 部署和配置

### 环境要求
- Node.js 16+
- SQLite 3.x
- AI服务端点配置

### 配置项
```typescript
// AI服务配置
const AI_CONFIG = {
  provider: 'ollama', // 'ollama' | 'deepseek' | 'openai'
  model: 'qwen2.5-coder:7b',
  baseUrl: 'http://localhost:11434',
  apiKey: process.env.AI_API_KEY
}
```

数据模型功能为DevAPI Manager提供了强大的数据结构管理能力，通过AI辅助解析大大提升了开发效率，是构建完整项目管理工具的重要组成部分。