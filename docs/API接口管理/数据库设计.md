# API接口管理数据库设计

## 1. 数据库架构概述

API接口管理模块将与现有的数据模型管理模块深度集成，共享同一个数据库实例。本设计遵循以下原则：

- **数据一致性**：确保API定义与数据模型的一致性
- **关联完整性**：维护API接口与数据表之间的关联关系
- **扩展性**：支持未来功能扩展和性能优化
- **兼容性**：与现有Prisma Schema完全兼容

## 2. 核心表结构设计

### 2.1 API接口管理核心表

#### 2.1.1 api_endpoints - API接口定义表

```sql
-- API接口定义表（扩展现有API表）
CREATE TABLE api_endpoints (
  id VARCHAR(36) PRIMARY KEY,
  project_id VARCHAR(36) NOT NULL,
  
  -- 基础信息
  name VARCHAR(100) NOT NULL,
  display_name VARCHAR(200),
  description TEXT,
  summary TEXT,
  
  -- 接口定义
  method VARCHAR(10) NOT NULL, -- GET, POST, PUT, DELETE, PATCH
  path VARCHAR(500) NOT NULL,
  operation_id VARCHAR(100),
  
  -- 分类和标签
  category VARCHAR(50),
  tags JSON, -- 标签数组
  
  -- 状态管理
  status VARCHAR(20) DEFAULT 'DRAFT', -- DRAFT, ACTIVE, DEPRECATED, DELETED
  visibility VARCHAR(20) DEFAULT 'PUBLIC', -- PUBLIC, PRIVATE, INTERNAL
  
  -- 版本信息
  version VARCHAR(20) DEFAULT '1.0.0',
  api_version VARCHAR(20), -- API版本（用于版本控制）
  
  -- 安全配置
  auth_required BOOLEAN DEFAULT TRUE,
  auth_type VARCHAR(20), -- bearer, api_key, oauth2, basic
  rate_limit_rpm INTEGER, -- 每分钟请求限制
  
  -- 业务配置
  timeout_ms INTEGER DEFAULT 30000,
  retry_count INTEGER DEFAULT 3,
  cache_ttl INTEGER, -- 缓存时间（秒）
  
  -- 关联数据模型
  primary_table_id VARCHAR(36), -- 主要关联的数据表
  related_tables JSON, -- 关联的其他表
  
  -- 自动生成标识
  is_auto_generated BOOLEAN DEFAULT FALSE,
  generation_config JSON, -- 生成配置
  last_sync_at TIMESTAMP, -- 最后同步时间
  
  -- 元数据
  created_by VARCHAR(36),
  last_modified_by VARCHAR(36),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  FOREIGN KEY (primary_table_id) REFERENCES database_tables(id) ON DELETE SET NULL,
  INDEX idx_project_id (project_id),
  INDEX idx_method_path (method, path),
  INDEX idx_status (status),
  INDEX idx_category (category),
  INDEX idx_primary_table (primary_table_id),
  UNIQUE KEY idx_unique_endpoint (project_id, method, path)
);
```

#### 2.1.2 api_parameters - API参数定义表

```sql
-- API参数定义表
CREATE TABLE api_parameters (
  id VARCHAR(36) PRIMARY KEY,
  endpoint_id VARCHAR(36) NOT NULL,
  
  -- 参数基础信息
  name VARCHAR(100) NOT NULL,
  display_name VARCHAR(200),
  description TEXT,
  
  -- 参数类型
  param_type VARCHAR(20) NOT NULL, -- path, query, header, body, form
  data_type VARCHAR(50) NOT NULL, -- string, integer, boolean, array, object
  format VARCHAR(50), -- email, date, uuid, etc.
  
  -- 约束
  required BOOLEAN DEFAULT FALSE,
  default_value TEXT,
  example_value TEXT,
  
  -- 数值约束
  min_value DECIMAL,
  max_value DECIMAL,
  min_length INTEGER,
  max_length INTEGER,
  pattern VARCHAR(500), -- 正则表达式
  
  -- 数组/对象约束
  min_items INTEGER,
  max_items INTEGER,
  enum_values JSON, -- 枚举值数组
  
  -- 关联字段
  related_field_id VARCHAR(36), -- 关联的数据表字段
  field_mapping JSON, -- 字段映射配置
  
  -- 排序和分组
  sort_order INTEGER DEFAULT 0,
  parameter_group VARCHAR(50),
  
  -- 验证规则
  validation_rules JSON,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (endpoint_id) REFERENCES api_endpoints(id) ON DELETE CASCADE,
  FOREIGN KEY (related_field_id) REFERENCES database_fields(id) ON DELETE SET NULL,
  INDEX idx_endpoint_id (endpoint_id),
  INDEX idx_param_type (param_type),
  INDEX idx_required (required),
  INDEX idx_related_field (related_field_id)
);
```

#### 2.1.3 api_responses - API响应定义表

```sql
-- API响应定义表
CREATE TABLE api_responses (
  id VARCHAR(36) PRIMARY KEY,
  endpoint_id VARCHAR(36) NOT NULL,
  
  -- 响应信息
  status_code INTEGER NOT NULL, -- 200, 201, 400, 404, 500, etc.
  description TEXT,
  
  -- 响应内容
  content_type VARCHAR(100) DEFAULT 'application/json',
  schema_definition JSON, -- JSON Schema定义
  example_response TEXT, -- 示例响应
  
  -- 响应头
  headers JSON, -- 响应头定义
  
  -- 数据映射
  field_mappings JSON, -- 响应字段到数据表字段的映射
  
  -- 是否默认响应
  is_default BOOLEAN DEFAULT FALSE,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (endpoint_id) REFERENCES api_endpoints(id) ON DELETE CASCADE,
  INDEX idx_endpoint_id (endpoint_id),
  INDEX idx_status_code (status_code),
  UNIQUE KEY idx_endpoint_status (endpoint_id, status_code)
);
```

### 2.2 API分组和组织

#### 2.2.1 api_groups - API分组表

```sql
-- API分组表
CREATE TABLE api_groups (
  id VARCHAR(36) PRIMARY KEY,
  project_id VARCHAR(36) NOT NULL,
  
  -- 分组信息
  name VARCHAR(100) NOT NULL,
  display_name VARCHAR(200),
  description TEXT,
  
  -- 层级结构
  parent_group_id VARCHAR(36),
  sort_order INTEGER DEFAULT 0,
  path VARCHAR(500), -- 完整路径，用于快速查询
  level INTEGER DEFAULT 0, -- 层级深度
  
  -- 分组配置
  base_path VARCHAR(200), -- 基础路径前缀
  common_headers JSON, -- 公共请求头
  common_auth JSON, -- 公共认证配置
  common_parameters JSON, -- 公共参数
  
  -- 分组状态
  is_active BOOLEAN DEFAULT TRUE,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  FOREIGN KEY (parent_group_id) REFERENCES api_groups(id) ON DELETE CASCADE,
  INDEX idx_project_id (project_id),
  INDEX idx_parent_group (parent_group_id),
  INDEX idx_path (path),
  INDEX idx_level (level)
);
```

#### 2.2.2 api_group_members - API与分组关联表

```sql
-- API与分组关联表
CREATE TABLE api_group_members (
  endpoint_id VARCHAR(36),
  group_id VARCHAR(36),
  sort_order INTEGER DEFAULT 0,
  
  PRIMARY KEY (endpoint_id, group_id),
  FOREIGN KEY (endpoint_id) REFERENCES api_endpoints(id) ON DELETE CASCADE,
  FOREIGN KEY (group_id) REFERENCES api_groups(id) ON DELETE CASCADE,
  INDEX idx_group_sort (group_id, sort_order)
);
```

### 2.3 测试管理表

#### 2.3.1 test_collections - 测试集合表

```sql
-- 测试集合表
CREATE TABLE test_collections (
  id VARCHAR(36) PRIMARY KEY,
  project_id VARCHAR(36) NOT NULL,
  
  -- 集合信息
  name VARCHAR(100) NOT NULL,
  description TEXT,
  
  -- 集合类型
  collection_type VARCHAR(20) DEFAULT 'MANUAL', -- MANUAL, AUTO_GENERATED, IMPORTED
  
  -- 执行配置
  environment VARCHAR(50), -- dev, test, staging, prod
  base_url VARCHAR(500),
  global_headers JSON,
  global_auth JSON,
  
  -- 环境变量
  environment_variables JSON,
  
  -- 执行配置
  execution_config JSON, -- 执行配置（并发数、超时等）
  
  -- 统计信息
  total_tests INTEGER DEFAULT 0,
  last_run_at TIMESTAMP,
  last_run_status VARCHAR(20), -- PENDING, RUNNING, PASSED, FAILED
  
  -- 定时执行
  schedule_enabled BOOLEAN DEFAULT FALSE,
  schedule_cron VARCHAR(100), -- Cron表达式
  
  created_by VARCHAR(36),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  INDEX idx_project_id (project_id),
  INDEX idx_collection_type (collection_type),
  INDEX idx_last_run_status (last_run_status)
);
```

#### 2.3.2 test_cases - 测试用例表

```sql
-- 测试用例表
CREATE TABLE test_cases (
  id VARCHAR(36) PRIMARY KEY,
  collection_id VARCHAR(36) NOT NULL,
  endpoint_id VARCHAR(36),
  
  -- 用例信息
  name VARCHAR(200) NOT NULL,
  description TEXT,
  
  -- 测试类型
  test_type VARCHAR(20) DEFAULT 'FUNCTIONAL', -- FUNCTIONAL, PERFORMANCE, SECURITY, INTEGRATION
  
  -- 测试配置
  method VARCHAR(10) NOT NULL,
  url VARCHAR(500) NOT NULL,
  headers JSON,
  query_params JSON,
  body_data TEXT,
  
  -- 前置条件
  pre_conditions JSON, -- 前置条件检查
  setup_script TEXT, -- 前置脚本
  teardown_script TEXT, -- 后置脚本
  
  -- 断言配置
  assertions JSON, -- 断言规则数组
  
  -- 执行配置
  timeout_ms INTEGER DEFAULT 10000,
  retry_count INTEGER DEFAULT 1,
  depends_on JSON, -- 依赖的其他测试用例
  
  -- 测试数据
  test_data JSON, -- 测试数据集
  data_driven BOOLEAN DEFAULT FALSE, -- 是否数据驱动测试
  
  -- 分组标签
  tags JSON,
  priority INTEGER DEFAULT 3, -- 1-5优先级
  
  -- 排序
  sort_order INTEGER DEFAULT 0,
  
  -- 状态
  is_enabled BOOLEAN DEFAULT TRUE,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (collection_id) REFERENCES test_collections(id) ON DELETE CASCADE,
  FOREIGN KEY (endpoint_id) REFERENCES api_endpoints(id) ON DELETE SET NULL,
  INDEX idx_collection_id (collection_id),
  INDEX idx_endpoint_id (endpoint_id),
  INDEX idx_test_type (test_type),
  INDEX idx_priority (priority)
);
```

#### 2.3.3 test_executions - 测试执行记录表

```sql
-- 测试执行结果表
CREATE TABLE test_executions (
  id VARCHAR(36) PRIMARY KEY,
  collection_id VARCHAR(36) NOT NULL,
  
  -- 执行信息
  execution_type VARCHAR(20) DEFAULT 'MANUAL', -- MANUAL, SCHEDULED, CI_CD, API_TRIGGER
  trigger_by VARCHAR(36),
  trigger_source VARCHAR(100), -- 触发源标识
  
  -- 执行状态
  status VARCHAR(20) DEFAULT 'PENDING', -- PENDING, RUNNING, COMPLETED, FAILED, CANCELLED
  start_time TIMESTAMP,
  end_time TIMESTAMP,
  duration_ms INTEGER,
  
  -- 执行结果
  total_tests INTEGER DEFAULT 0,
  passed_tests INTEGER DEFAULT 0,
  failed_tests INTEGER DEFAULT 0,
  skipped_tests INTEGER DEFAULT 0,
  error_tests INTEGER DEFAULT 0,
  
  -- 执行环境
  environment VARCHAR(50),
  executor_info JSON, -- 执行器信息
  execution_config JSON, -- 本次执行的配置
  
  -- 报告
  report_summary JSON, -- 报告摘要
  report_url VARCHAR(500), -- 详细报告URL
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (collection_id) REFERENCES test_collections(id) ON DELETE CASCADE,
  INDEX idx_collection_id (collection_id),
  INDEX idx_status (status),
  INDEX idx_start_time (start_time),
  INDEX idx_execution_type (execution_type)
);
```

#### 2.3.4 test_case_results - 测试用例执行结果表

```sql
-- 测试用例执行结果表
CREATE TABLE test_case_results (
  id VARCHAR(36) PRIMARY KEY,
  execution_id VARCHAR(36) NOT NULL,
  test_case_id VARCHAR(36) NOT NULL,
  
  -- 执行结果
  status VARCHAR(20) NOT NULL, -- PASSED, FAILED, SKIPPED, ERROR
  start_time TIMESTAMP,
  end_time TIMESTAMP,
  duration_ms INTEGER,
  
  -- 请求响应
  request_data JSON, -- 实际发送的请求
  response_data JSON, -- 收到的响应
  
  -- 断言结果
  assertion_results JSON, -- 断言结果详情
  
  -- 性能数据
  performance_metrics JSON, -- 性能指标
  
  -- 错误信息
  error_message TEXT,
  error_stack TEXT,
  error_type VARCHAR(50), -- TIMEOUT, NETWORK, ASSERTION, SCRIPT_ERROR
  
  -- 重试信息
  retry_count INTEGER DEFAULT 0,
  retry_results JSON, -- 重试结果
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (execution_id) REFERENCES test_executions(id) ON DELETE CASCADE,
  FOREIGN KEY (test_case_id) REFERENCES test_cases(id) ON DELETE CASCADE,
  INDEX idx_execution_id (execution_id),
  INDEX idx_test_case_id (test_case_id),
  INDEX idx_status (status),
  INDEX idx_duration (duration_ms)
);
```

### 2.4 文档和版本管理表

#### 2.4.1 api_documentations - API文档表

```sql
-- API文档表
CREATE TABLE api_documentations (
  id VARCHAR(36) PRIMARY KEY,
  project_id VARCHAR(36) NOT NULL,
  
  -- 文档信息
  title VARCHAR(200) NOT NULL,
  description TEXT,
  version VARCHAR(20) DEFAULT '1.0.0',
  
  -- 文档内容
  content TEXT, -- Markdown内容
  openapi_spec JSON, -- OpenAPI 3.0规范
  
  -- 发布配置
  is_published BOOLEAN DEFAULT FALSE,
  publish_url VARCHAR(500),
  custom_domain VARCHAR(200),
  
  -- 主题配置
  theme_config JSON,
  custom_css TEXT,
  custom_js TEXT,
  
  -- 访问控制
  is_public BOOLEAN DEFAULT TRUE,
  access_token VARCHAR(100),
  allowed_domains JSON, -- 允许访问的域名
  
  -- 生成配置
  auto_sync BOOLEAN DEFAULT TRUE, -- 自动同步API变更
  include_examples BOOLEAN DEFAULT TRUE,
  include_schemas BOOLEAN DEFAULT TRUE,
  
  -- 统计信息
  view_count INTEGER DEFAULT 0,
  last_viewed_at TIMESTAMP,
  
  created_by VARCHAR(36),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  INDEX idx_project_id (project_id),
  INDEX idx_is_published (is_published),
  INDEX idx_custom_domain (custom_domain)
);
```

#### 2.4.2 api_versions - API版本表

```sql
-- API版本表
CREATE TABLE api_versions (
  id VARCHAR(36) PRIMARY KEY,
  project_id VARCHAR(36) NOT NULL,
  
  -- 版本信息
  version_number VARCHAR(20) NOT NULL,
  version_name VARCHAR(100),
  description TEXT,
  
  -- 版本类型
  version_type VARCHAR(20) DEFAULT 'MINOR', -- MAJOR, MINOR, PATCH
  is_stable BOOLEAN DEFAULT FALSE,
  is_deprecated BOOLEAN DEFAULT FALSE,
  is_default BOOLEAN DEFAULT FALSE, -- 是否为默认版本
  
  -- 发布信息
  release_date TIMESTAMP,
  deprecation_date TIMESTAMP,
  sunset_date TIMESTAMP,
  
  -- 变更信息
  changelog TEXT,
  breaking_changes JSON,
  migration_guide TEXT,
  
  -- 快照
  api_snapshot JSON, -- 该版本的API快照
  endpoints_count INTEGER DEFAULT 0,
  
  -- 兼容性
  backward_compatible BOOLEAN DEFAULT TRUE,
  minimum_client_version VARCHAR(20),
  
  created_by VARCHAR(36),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  INDEX idx_project_id (project_id),
  INDEX idx_version_number (version_number),
  INDEX idx_is_stable (is_stable),
  INDEX idx_is_default (is_default),
  UNIQUE KEY idx_project_version (project_id, version_number)
);
```

#### 2.4.3 api_change_logs - API变更日志表

```sql
-- API变更日志表
CREATE TABLE api_change_logs (
  id VARCHAR(36) PRIMARY KEY,
  project_id VARCHAR(36) NOT NULL,
  endpoint_id VARCHAR(36),
  
  -- 变更信息
  change_type VARCHAR(20) NOT NULL, -- CREATE, UPDATE, DELETE, DEPRECATE
  change_category VARCHAR(20), -- BREAKING, NON_BREAKING, INTERNAL
  change_scope VARCHAR(20), -- ENDPOINT, PARAMETER, RESPONSE, METADATA
  
  -- 变更内容
  field_name VARCHAR(100), -- 变更的字段名
  old_value TEXT, -- 变更前的值
  new_value TEXT, -- 变更后的值
  change_description TEXT,
  
  -- 变更差异
  diff_data JSON, -- 详细的变更差异
  
  -- 影响分析
  impact_level VARCHAR(20), -- HIGH, MEDIUM, LOW
  affected_consumers JSON, -- 受影响的消费者
  compatibility_notes TEXT,
  
  -- 版本信息
  from_version VARCHAR(20),
  to_version VARCHAR(20),
  
  -- 审批流程
  approval_status VARCHAR(20) DEFAULT 'PENDING', -- PENDING, APPROVED, REJECTED
  approved_by VARCHAR(36),
  approved_at TIMESTAMP,
  approval_notes TEXT,
  
  -- 操作信息
  changed_by VARCHAR(36),
  change_reason TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  FOREIGN KEY (endpoint_id) REFERENCES api_endpoints(id) ON DELETE CASCADE,
  INDEX idx_project_id (project_id),
  INDEX idx_endpoint_id (endpoint_id),
  INDEX idx_change_type (change_type),
  INDEX idx_change_category (change_category),
  INDEX idx_impact_level (impact_level),
  INDEX idx_created_at (created_at)
);
```

### 2.5 监控和分析表

#### 2.5.1 api_usage_stats - API使用统计表

```sql
-- API使用统计表
CREATE TABLE api_usage_stats (
  id VARCHAR(36) PRIMARY KEY,
  endpoint_id VARCHAR(36) NOT NULL,
  
  -- 时间维度
  stat_date DATE NOT NULL,
  stat_hour INTEGER, -- 0-23，为null表示日统计
  
  -- 使用统计
  request_count INTEGER DEFAULT 0,
  success_count INTEGER DEFAULT 0,
  error_count INTEGER DEFAULT 0,
  
  -- 状态码统计
  status_2xx_count INTEGER DEFAULT 0,
  status_3xx_count INTEGER DEFAULT 0,
  status_4xx_count INTEGER DEFAULT 0,
  status_5xx_count INTEGER DEFAULT 0,
  
  -- 响应时间统计
  avg_response_time DECIMAL(10,2),
  min_response_time DECIMAL(10,2),
  max_response_time DECIMAL(10,2),
  p50_response_time DECIMAL(10,2),
  p95_response_time DECIMAL(10,2),
  p99_response_time DECIMAL(10,2),
  
  -- 数据传输统计
  total_bytes_sent BIGINT DEFAULT 0,
  total_bytes_received BIGINT DEFAULT 0,
  avg_request_size DECIMAL(10,2),
  avg_response_size DECIMAL(10,2),
  
  -- 错误统计
  timeout_count INTEGER DEFAULT 0,
  rate_limit_count INTEGER DEFAULT 0,
  
  -- 用户统计
  unique_users INTEGER DEFAULT 0,
  unique_ips INTEGER DEFAULT 0,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (endpoint_id) REFERENCES api_endpoints(id) ON DELETE CASCADE,
  UNIQUE KEY idx_endpoint_date_hour (endpoint_id, stat_date, stat_hour),
  INDEX idx_stat_date (stat_date),
  INDEX idx_endpoint_id (endpoint_id),
  INDEX idx_request_count (request_count)
);
```

#### 2.5.2 api_error_logs - API错误日志表

```sql
-- API错误日志表
CREATE TABLE api_error_logs (
  id VARCHAR(36) PRIMARY KEY,
  endpoint_id VARCHAR(36) NOT NULL,
  
  -- 请求信息
  request_id VARCHAR(100),
  method VARCHAR(10),
  path VARCHAR(500),
  query_string TEXT,
  user_agent TEXT,
  ip_address VARCHAR(45),
  user_id VARCHAR(36), -- 用户ID（如果有认证）
  
  -- 错误信息
  status_code INTEGER,
  error_type VARCHAR(50), -- VALIDATION, AUTHENTICATION, AUTHORIZATION, SERVER_ERROR, TIMEOUT
  error_code VARCHAR(100), -- 业务错误码
  error_message TEXT,
  error_stack TEXT,
  
  -- 时间信息
  request_time TIMESTAMP,
  response_time TIMESTAMP,
  duration_ms INTEGER,
  
  -- 请求响应数据
  request_headers JSON,
  request_body TEXT,
  response_headers JSON,
  response_body TEXT,
  
  -- 环境信息
  environment VARCHAR(50),
  server_instance VARCHAR(100),
  
  -- 分类标签
  tags JSON,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (endpoint_id) REFERENCES api_endpoints(id) ON DELETE CASCADE,
  INDEX idx_endpoint_id (endpoint_id),
  INDEX idx_status_code (status_code),
  INDEX idx_error_type (error_type),
  INDEX idx_request_time (request_time),
  INDEX idx_user_id (user_id),
  INDEX idx_ip_address (ip_address)
);
```

#### 2.5.3 api_performance_monitors - API性能监控表

```sql
-- API性能监控表
CREATE TABLE api_performance_monitors (
  id VARCHAR(36) PRIMARY KEY,
  endpoint_id VARCHAR(36) NOT NULL,
  
  -- 监控配置
  monitor_name VARCHAR(100) NOT NULL,
  monitor_type VARCHAR(20) DEFAULT 'AVAILABILITY', -- AVAILABILITY, PERFORMANCE, FUNCTIONAL
  
  -- 检查配置
  check_interval INTEGER DEFAULT 300, -- 检查间隔（秒）
  timeout_ms INTEGER DEFAULT 10000,
  check_locations JSON, -- 检查位置
  
  -- 阈值配置
  response_time_threshold INTEGER, -- 响应时间阈值（毫秒）
  error_rate_threshold DECIMAL(5,2), -- 错误率阈值（百分比）
  availability_threshold DECIMAL(5,2), -- 可用性阈值（百分比）
  
  -- 告警配置
  alert_enabled BOOLEAN DEFAULT TRUE,
  alert_contacts JSON, -- 告警联系人
  alert_channels JSON, -- 告警渠道（email, slack, webhook）
  escalation_rules JSON, -- 升级规则
  
  -- 状态
  is_active BOOLEAN DEFAULT TRUE,
  last_check_at TIMESTAMP,
  current_status VARCHAR(20), -- UP, DOWN, DEGRADED
  status_since TIMESTAMP,
  
  -- 统计
  uptime_percentage DECIMAL(5,2), -- 近30天可用性
  avg_response_time DECIMAL(10,2), -- 近期平均响应时间
  total_checks INTEGER DEFAULT 0,
  failed_checks INTEGER DEFAULT 0,
  
  created_by VARCHAR(36),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (endpoint_id) REFERENCES api_endpoints(id) ON DELETE CASCADE,
  INDEX idx_endpoint_id (endpoint_id),
  INDEX idx_is_active (is_active),
  INDEX idx_current_status (current_status),
  INDEX idx_last_check (last_check_at)
);
```

### 2.6 集成同步表

#### 2.6.1 api_model_sync_logs - API数据模型同步日志表

```sql
-- API数据模型同步日志
CREATE TABLE api_model_sync_logs (
  id VARCHAR(36) PRIMARY KEY,
  project_id VARCHAR(36) NOT NULL,
  table_id VARCHAR(36),
  endpoint_id VARCHAR(36),
  
  -- 同步类型
  sync_type VARCHAR(30) NOT NULL, -- TABLE_CREATED, TABLE_UPDATED, TABLE_DELETED, FIELD_CHANGED, API_CREATED, API_UPDATED
  sync_direction VARCHAR(20) NOT NULL, -- MODEL_TO_API, API_TO_MODEL, BIDIRECTIONAL
  sync_action VARCHAR(20), -- AUTO_SYNC, MANUAL_SYNC, SKIP_SYNC, CONFLICT_DETECTED
  
  -- 触发信息
  trigger_event VARCHAR(50), -- 触发事件
  trigger_by VARCHAR(36), -- 触发用户
  
  -- 同步内容
  changes_detected JSON, -- 检测到的变更
  changes_applied JSON, -- 应用的变更
  conflicts_found JSON, -- 发现的冲突
  
  -- 同步结果
  sync_result JSON, -- 同步结果详情
  
  -- 同步状态
  sync_status VARCHAR(20) DEFAULT 'PENDING', -- PENDING, SUCCESS, FAILED, SKIPPED, CONFLICT
  error_message TEXT,
  error_details JSON,
  
  -- 版本信息
  before_version JSON, -- 同步前的版本快照
  after_version JSON, -- 同步后的版本快照
  
  -- 处理时间
  processing_time_ms INTEGER,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  FOREIGN KEY (table_id) REFERENCES database_tables(id) ON DELETE SET NULL,
  FOREIGN KEY (endpoint_id) REFERENCES api_endpoints(id) ON DELETE SET NULL,
  INDEX idx_project_id (project_id),
  INDEX idx_table_id (table_id),
  INDEX idx_endpoint_id (endpoint_id),
  INDEX idx_sync_type (sync_type),
  INDEX idx_sync_status (sync_status),
  INDEX idx_created_at (created_at)
);
```

#### 2.6.2 api_field_mappings - API字段映射表

```sql
-- API字段映射表（用于明确API参数与数据库字段的映射关系）
CREATE TABLE api_field_mappings (
  id VARCHAR(36) PRIMARY KEY,
  endpoint_id VARCHAR(36) NOT NULL,
  parameter_id VARCHAR(36),
  response_id VARCHAR(36),
  table_id VARCHAR(36) NOT NULL,
  field_id VARCHAR(36) NOT NULL,
  
  -- 映射类型
  mapping_type VARCHAR(20) NOT NULL, -- REQUEST_PARAM, RESPONSE_FIELD, FILTER_PARAM
  mapping_context VARCHAR(50), -- CREATE, UPDATE, READ, DELETE, SEARCH
  
  -- 映射配置
  field_path VARCHAR(200), -- 在API中的字段路径（支持嵌套）
  transformation_rules JSON, -- 数据转换规则
  
  -- 验证规则
  validation_enabled BOOLEAN DEFAULT TRUE,
  custom_validation JSON, -- 自定义验证规则
  
  -- 状态
  is_active BOOLEAN DEFAULT TRUE,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (endpoint_id) REFERENCES api_endpoints(id) ON DELETE CASCADE,
  FOREIGN KEY (parameter_id) REFERENCES api_parameters(id) ON DELETE CASCADE,
  FOREIGN KEY (response_id) REFERENCES api_responses(id) ON DELETE CASCADE,
  FOREIGN KEY (table_id) REFERENCES database_tables(id) ON DELETE CASCADE,
  FOREIGN KEY (field_id) REFERENCES database_fields(id) ON DELETE CASCADE,
  INDEX idx_endpoint_id (endpoint_id),
  INDEX idx_table_field (table_id, field_id),
  INDEX idx_mapping_type (mapping_type),
  INDEX idx_is_active (is_active)
);
```

### 2.7 扩展现有表结构

#### 2.7.1 扩展 database_tables 表

```sql
-- 为数据表添加API生成配置
ALTER TABLE database_tables 
ADD COLUMN api_enabled BOOLEAN DEFAULT TRUE,
ADD COLUMN api_base_path VARCHAR(200),
ADD COLUMN api_auth_required BOOLEAN DEFAULT TRUE,
ADD COLUMN api_operations JSON, -- 启用的操作：CREATE, READ, UPDATE, DELETE
ADD COLUMN api_config JSON, -- API生成配置
ADD COLUMN last_api_sync_at TIMESTAMP;

-- 添加索引
CREATE INDEX idx_database_tables_api_enabled ON database_tables(api_enabled);
```

#### 2.7.2 扩展 database_fields 表

```sql
-- 字段级API配置
ALTER TABLE database_fields 
ADD COLUMN api_visible BOOLEAN DEFAULT TRUE,
ADD COLUMN api_required BOOLEAN,
ADD COLUMN api_readonly BOOLEAN DEFAULT FALSE,
ADD COLUMN api_validation_rules JSON,
ADD COLUMN api_field_name VARCHAR(100), -- 在API中的字段名
ADD COLUMN api_description TEXT; -- API文档中的字段描述

-- 添加索引
CREATE INDEX idx_database_fields_api_visible ON database_fields(api_visible);
```

#### 2.7.3 扩展 projects 表

```sql
-- 项目级API配置
ALTER TABLE projects 
ADD COLUMN api_base_url VARCHAR(500),
ADD COLUMN api_version_strategy VARCHAR(20) DEFAULT 'HEADER', -- HEADER, PATH, QUERY
ADD COLUMN api_auth_config JSON,
ADD COLUMN api_cors_config JSON,
ADD COLUMN api_rate_limit_config JSON,
ADD COLUMN api_documentation_config JSON;
```

## 3. 数据库视图和索引优化

### 3.1 常用视图

#### 3.1.1 API概览视图

```sql
-- API概览视图
CREATE VIEW v_api_overview AS
SELECT 
    e.id,
    e.project_id,
    e.name,
    e.display_name,
    e.method,
    e.path,
    e.status,
    e.category,
    dt.name as primary_table_name,
    dt.display_name as primary_table_display_name,
    COUNT(DISTINCT p.id) as parameter_count,
    COUNT(DISTINCT r.id) as response_count,
    GROUP_CONCAT(DISTINCT g.name) as group_names,
    e.created_at,
    e.updated_at
FROM api_endpoints e
LEFT JOIN database_tables dt ON e.primary_table_id = dt.id
LEFT JOIN api_parameters p ON e.id = p.endpoint_id
LEFT JOIN api_responses r ON e.id = r.endpoint_id
LEFT JOIN api_group_members gm ON e.id = gm.endpoint_id
LEFT JOIN api_groups g ON gm.group_id = g.id
GROUP BY e.id;
```

#### 3.1.2 测试执行统计视图

```sql
-- 测试执行统计视图
CREATE VIEW v_test_execution_stats AS
SELECT 
    tc.id as collection_id,
    tc.name as collection_name,
    tc.project_id,
    COUNT(DISTINCT tcr.test_case_id) as total_test_cases,
    COUNT(DISTINCT te.id) as total_executions,
    AVG(te.passed_tests) as avg_passed_tests,
    AVG(te.failed_tests) as avg_failed_tests,
    AVG(te.duration_ms) as avg_execution_time,
    MAX(te.start_time) as last_execution_time,
    (SELECT status FROM test_executions WHERE collection_id = tc.id ORDER BY start_time DESC LIMIT 1) as last_status
FROM test_collections tc
LEFT JOIN test_executions te ON tc.id = te.collection_id
LEFT JOIN test_case_results tcr ON te.id = tcr.execution_id
GROUP BY tc.id;
```

### 3.2 性能优化索引

```sql
-- 复合索引优化
CREATE INDEX idx_api_endpoints_project_status ON api_endpoints(project_id, status);
CREATE INDEX idx_api_endpoints_method_path_status ON api_endpoints(method, path, status);
CREATE INDEX idx_api_parameters_endpoint_type ON api_parameters(endpoint_id, param_type);
CREATE INDEX idx_api_usage_stats_date_endpoint ON api_usage_stats(stat_date, endpoint_id);
CREATE INDEX idx_api_error_logs_time_endpoint ON api_error_logs(request_time, endpoint_id);
CREATE INDEX idx_test_case_results_execution_status ON test_case_results(execution_id, status);

-- 全文搜索索引
CREATE FULLTEXT INDEX idx_api_endpoints_search ON api_endpoints(name, display_name, description);
CREATE FULLTEXT INDEX idx_test_cases_search ON test_cases(name, description);
```

## 4. 数据类型和约束

### 4.1 枚举类型定义

```sql
-- API方法枚举
-- GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS

-- API状态枚举
-- DRAFT: 草稿状态
-- ACTIVE: 活跃状态
-- DEPRECATED: 已废弃
-- DELETED: 已删除

-- 参数类型枚举
-- path: 路径参数
-- query: 查询参数
-- header: 请求头参数
-- body: 请求体参数
-- form: 表单参数

-- 数据类型枚举
-- string, integer, number, boolean, array, object, file

-- 测试状态枚举
-- PENDING: 等待执行
-- RUNNING: 执行中
-- PASSED: 执行成功
-- FAILED: 执行失败
-- SKIPPED: 跳过执行
-- ERROR: 执行错误
```

### 4.2 JSON字段结构

#### 4.2.1 api_endpoints.tags
```json
{
  "tags": [
    "user-management",
    "crud",
    "v1"
  ]
}
```

#### 4.2.2 api_parameters.validation_rules
```json
{
  "validation_rules": {
    "type": "string",
    "pattern": "^[a-zA-Z0-9]+$",
    "minLength": 3,
    "maxLength": 50,
    "customRules": [
      {
        "rule": "unique",
        "field": "username",
        "message": "用户名已存在"
      }
    ]
  }
}
```

#### 4.2.3 api_responses.schema_definition
```json
{
  "schema_definition": {
    "type": "object",
    "properties": {
      "id": {"type": "string", "format": "uuid"},
      "name": {"type": "string"},
      "email": {"type": "string", "format": "email"},
      "created_at": {"type": "string", "format": "date-time"}
    },
    "required": ["id", "name", "email"]
  }
}
```

#### 4.2.4 test_cases.assertions
```json
{
  "assertions": [
    {
      "type": "status_code",
      "expected": 200,
      "message": "响应状态码应为200"
    },
    {
      "type": "json_path",
      "path": "$.data.id",
      "expected": "not_null",
      "message": "返回的ID不能为空"
    },
    {
      "type": "response_time",
      "operator": "less_than",
      "expected": 1000,
      "message": "响应时间应小于1秒"
    }
  ]
}
```

## 5. 数据迁移策略

### 5.1 初始迁移

```sql
-- 1. 创建API管理相关表
-- （执行上述所有CREATE TABLE语句）

-- 2. 迁移现有API数据（如果有）
INSERT INTO api_endpoints (
  id, project_id, name, display_name, method, path, status, created_at, updated_at
)
SELECT 
  id, project_id, title as name, title as display_name, method, path, status, created_at, updated_at
FROM apis
WHERE apis.id IS NOT NULL;

-- 3. 创建默认API分组
INSERT INTO api_groups (id, project_id, name, display_name, description)
SELECT 
  CONCAT(id, '-default') as id,
  id as project_id,
  'Default' as name,
  '默认分组' as display_name,
  '系统自动创建的默认API分组' as description
FROM projects;

-- 4. 初始化项目API配置
UPDATE projects SET 
  api_base_url = CONCAT('https://api.', LOWER(name), '.com'),
  api_version_strategy = 'HEADER',
  api_auth_config = '{"type": "bearer", "required": true}',
  api_cors_config = '{"enabled": true, "origins": ["*"]}',
  api_rate_limit_config = '{"requests_per_minute": 1000}';
```

### 5.2 增量迁移

```sql
-- 为现有数据表启用API功能
UPDATE database_tables SET 
  api_enabled = TRUE,
  api_base_path = CONCAT('/', LOWER(name)),
  api_auth_required = TRUE,
  api_operations = '["CREATE", "READ", "UPDATE", "DELETE"]'
WHERE status = 'ACTIVE';

-- 为现有字段设置API可见性
UPDATE database_fields SET 
  api_visible = CASE 
    WHEN name IN ('password', 'secret', 'token') THEN FALSE
    ELSE TRUE
  END,
  api_readonly = CASE 
    WHEN name IN ('id', 'created_at', 'updated_at') THEN TRUE
    ELSE FALSE
  END,
  api_field_name = name;
```

## 6. 备份和维护

### 6.1 数据备份策略

```sql
-- 关键表的备份脚本
CREATE TABLE api_endpoints_backup AS SELECT * FROM api_endpoints;
CREATE TABLE api_parameters_backup AS SELECT * FROM api_parameters;
CREATE TABLE api_responses_backup AS SELECT * FROM api_responses;
CREATE TABLE test_collections_backup AS SELECT * FROM test_collections;
CREATE TABLE test_cases_backup AS SELECT * FROM test_cases;
```

### 6.2 数据清理策略

```sql
-- 清理30天前的错误日志
DELETE FROM api_error_logs 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);

-- 清理90天前的测试执行记录
DELETE FROM test_executions 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- 清理180天前的使用统计
DELETE FROM api_usage_stats 
WHERE stat_date < DATE_SUB(CURDATE(), INTERVAL 180 DAY);

-- 清理已删除API的相关数据
DELETE FROM api_parameters 
WHERE endpoint_id IN (
  SELECT id FROM api_endpoints WHERE status = 'DELETED' 
  AND updated_at < DATE_SUB(NOW(), INTERVAL 7 DAY)
);
```

## 7. 监控和优化

### 7.1 性能监控查询

```sql
-- 检查慢查询的API
SELECT 
  e.name,
  e.method,
  e.path,
  AVG(us.avg_response_time) as avg_response,
  SUM(us.request_count) as total_requests
FROM api_endpoints e
JOIN api_usage_stats us ON e.id = us.endpoint_id
WHERE us.stat_date >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
GROUP BY e.id
HAVING avg_response > 1000
ORDER BY avg_response DESC;

-- 检查高错误率的API
SELECT 
  e.name,
  e.method,
  e.path,
  SUM(us.error_count) as total_errors,
  SUM(us.request_count) as total_requests,
  (SUM(us.error_count) / SUM(us.request_count)) * 100 as error_rate
FROM api_endpoints e
JOIN api_usage_stats us ON e.id = us.endpoint_id
WHERE us.stat_date >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
GROUP BY e.id
HAVING error_rate > 5
ORDER BY error_rate DESC;
```

### 7.2 数据一致性检查

```sql
-- 检查API参数与数据库字段的一致性
SELECT 
  e.name as endpoint_name,
  p.name as parameter_name,
  f.name as field_name,
  p.data_type as param_type,
  f.type as field_type
FROM api_endpoints e
JOIN api_parameters p ON e.id = p.endpoint_id
JOIN database_fields f ON p.related_field_id = f.id
WHERE p.data_type != f.type;

-- 检查无效的外键引用
SELECT 'api_endpoints' as table_name, COUNT(*) as invalid_count
FROM api_endpoints e
LEFT JOIN database_tables dt ON e.primary_table_id = dt.id
WHERE e.primary_table_id IS NOT NULL AND dt.id IS NULL

UNION ALL

SELECT 'api_parameters' as table_name, COUNT(*) as invalid_count
FROM api_parameters p
LEFT JOIN database_fields f ON p.related_field_id = f.id
WHERE p.related_field_id IS NOT NULL AND f.id IS NULL;
```

## 8. 安全考虑

### 8.1 数据访问控制

```sql
-- 创建只读用户
CREATE USER 'api_readonly'@'%' IDENTIFIED BY 'secure_password';
GRANT SELECT ON *.* TO 'api_readonly'@'%';

-- 创建API管理用户
CREATE USER 'api_manager'@'%' IDENTIFIED BY 'secure_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON api_*.* TO 'api_manager'@'%';
GRANT SELECT ON database_*.* TO 'api_manager'@'%';
```

### 8.2 敏感数据保护

```sql
-- 敏感字段加密存储
ALTER TABLE api_error_logs 
ADD COLUMN request_body_encrypted TEXT,
ADD COLUMN response_body_encrypted TEXT;

-- 数据脱敏视图
CREATE VIEW v_api_error_logs_safe AS
SELECT 
  id, endpoint_id, request_id, method, path, status_code, error_type, error_message,
  request_time, response_time, duration_ms,
  CASE 
    WHEN request_body LIKE '%password%' THEN '***MASKED***'
    ELSE LEFT(request_body, 500)
  END as request_body_safe,
  created_at
FROM api_error_logs;
```

---

**文档版本**: v1.0  
**创建时间**: 2025-08-16  
**最后更新**: 2025-08-16  
**维护人员**: DevAPI团队