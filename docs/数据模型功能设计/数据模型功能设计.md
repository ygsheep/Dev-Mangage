# DevAPI Manager 数据模型功能设计文档

## 1. 项目概述

### 1.1 项目背景
DevAPI Manager是一个现代化的API管理平台，致力于为开发者提供全方位的API生命周期管理解决方案。数据模型管理作为平台的核心功能之一，旨在帮助开发者更好地设计、管理和维护数据库结构。

### 1.2 功能目标
- **可视化数据模型管理**：提供直观的数据表结构管理界面
- **智能化文档解析**：支持AI解析各类数据库设计文档
- **完整的关系管理**：支持表间关系、外键约束的可视化管理
- **SQL代码生成**：自动生成标准的DDL语句
- **版本控制支持**：跟踪数据模型的变更历史
- **团队协作功能**：支持多人协作的数据模型设计

### 1.3 技术架构
- **前端框架**：React 18 + TypeScript + Tailwind CSS
- **后端服务**：Node.js + Express + Prisma ORM
- **数据存储**：SQLite（支持PostgreSQL/MySQL扩展）
- **AI集成**：支持Ollama、OpenAI、DeepSeek等AI服务

## 2. 功能详细设计

### 2.1 数据表管理功能

#### 2.1.1 表基础信息管理
**功能描述**：管理数据表的基础属性信息

**核心功能**：
- 表名和显示名管理
- 表注释和描述信息
- 存储引擎配置（InnoDB、MyISAM等）
- 字符集和排序规则设置
- 表分类和标签管理
- 状态管理（草稿、已创建、已废弃）

**界面设计**：
```
┌─────────────────────────────────────────┐
│ 表基础信息                               │
├─────────────────────────────────────────┤
│ 表名称: user_accounts                   │
│ 显示名: 用户账户表                       │
│ 描述: 存储用户账户基础信息                │
│ 分类: [用户系统] [核心表]                │
│ 状态: ● 已创建                          │
│ 引擎: InnoDB  字符集: utf8mb4            │
└─────────────────────────────────────────┘
```

#### 2.1.2 字段结构管理
**功能描述**：管理数据表中的字段定义

**核心功能**：
- 字段名称和类型定义
- 长度、精度、标度设置
- 默认值和注释管理
- 约束属性（主键、唯一、非空等）
- 自增长属性设置
- 字段排序和分组
- 枚举值管理
- 外键关系配置

**支持的数据类型**：
- 数值类型：INT, BIGINT, DECIMAL, FLOAT, DOUBLE
- 字符类型：VARCHAR, TEXT, LONGTEXT
- 时间类型：DATETIME, TIMESTAMP, DATE, TIME
- 其他类型：BOOLEAN, JSON, ENUM, BLOB

**界面设计**：
```
┌─────────────────────────────────────────────────────────────────┐
│ 字段结构管理                                                     │
├─────────────────────────────────────────────────────────────────┤
│ [🔍 搜索字段...] [类型筛选 ▼] [+ 添加字段]                        │
├──┬──────────┬────────┬─────┬──────────┬────────────┬──────────────┤
│🔑│ 字段名    │ 类型   │ 长度 │ 属性     │ 默认值     │ 注释         │
├──┼──────────┼────────┼─────┼──────────┼────────────┼──────────────┤
│🗝️│ id       │ BIGINT │  -  │ PK AI NN │     -      │ 用户唯一标识  │
│  │ username │ VARCHAR│ 50  │ UQ NN    │     -      │ 用户名       │
│  │ email    │ VARCHAR│100  │ UQ NN    │     -      │ 邮箱地址     │
│  │ status   │ ENUM   │  -  │ NN       │  'active'  │ 账户状态     │
│  │ created  │ TIMESTAMP│-  │ NN       │ CURRENT_TS │ 创建时间     │
└──┴──────────┴────────┴─────┴──────────┴────────────┴──────────────┘
```

#### 2.1.3 索引管理功能
**功能描述**：管理数据表的索引结构

**核心功能**：
- 主键索引管理
- 唯一索引创建
- 普通索引优化
- 复合索引设计
- 全文索引支持
- 索引性能分析

**索引类型**：
- PRIMARY：主键索引
- UNIQUE：唯一索引
- INDEX：普通索引
- FULLTEXT：全文索引
- FOREIGN：外键索引

**界面设计**：
```
┌─────────────────────────────────────────────────────────────┐
│ 索引管理                                                     │
├─────────────────────────────────────────────────────────────┤
│ [+ 添加索引] [🔄 重建索引] [📊 性能分析]                      │
├──┬──────────────┬─────────┬──────────────┬─────────┬────────┤
│  │ 索引名称      │ 类型    │ 包含字段      │ 唯一性  │ 状态   │
├──┼──────────────┼─────────┼──────────────┼─────────┼────────┤
│  │ PRIMARY      │ PRIMARY │ id           │   是    │ 正常   │
│  │ idx_username │ INDEX   │ username     │   否    │ 正常   │
│  │ idx_email    │ UNIQUE  │ email        │   是    │ 正常   │
│  │ idx_status   │ INDEX   │ status,created│   否    │ 正常   │
└──┴──────────────┴─────────┴──────────────┴─────────┴────────┘
```

### 2.2 关联关系管理

#### 2.2.1 外键关系设计
**功能描述**：管理表间的外键关系和约束

**核心功能**：
- 一对一关系管理
- 一对多关系管理
- 多对多关系管理
- 外键约束行为配置
- 级联操作设置
- 关系图可视化

**关系类型**：
- ONE_TO_ONE：一对一关系
- ONE_TO_MANY：一对多关系
- MANY_TO_MANY：多对多关系

**约束行为**：
- CASCADE：级联操作
- SET NULL：设置为NULL
- RESTRICT：限制操作
- NO ACTION：无操作

#### 2.2.2 关系图可视化
**功能描述**：以图形化方式展示表间关系

**核心功能**：
- 表关系拓扑图
- 交互式关系编辑
- 关系路径分析
- 依赖关系检查
- 数据流向可视化

### 2.3 SQL代码生成

#### 2.3.1 DDL语句生成
**功能描述**：基于数据模型自动生成标准DDL语句

**生成内容**：
- CREATE TABLE语句
- ALTER TABLE语句
- CREATE INDEX语句
- FOREIGN KEY约束
- 数据库初始化脚本

**生成示例**：
```sql
-- 生成的CREATE TABLE语句
CREATE TABLE `user_accounts` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户唯一标识',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `email` VARCHAR(100) NOT NULL COMMENT '邮箱地址',
  `status` ENUM('active', 'inactive', 'suspended') NOT NULL DEFAULT 'active' COMMENT '账户状态',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_username` (`username`),
  UNIQUE KEY `idx_email` (`email`),
  KEY `idx_status` (`status`, `created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户账户表';
```

#### 2.3.2 迁移脚本生成
**功能描述**：生成数据库版本迁移脚本

**核心功能**：
- 版本差异分析
- 迁移脚本生成
- 回滚脚本生成
- 数据迁移支持

### 2.4 智能化文档解析

#### 2.4.1 AI文档解析
**功能描述**：利用AI技术解析各类数据库设计文档

**支持格式**：
- Markdown设计文档
- SQL建表语句
- Excel数据字典
- Word设计文档
- JSON Schema定义

**AI服务集成**：
- Ollama本地模型
- OpenAI GPT系列
- DeepSeek代码模型
- 自定义AI服务

**解析流程**：
```
文档上传 → AI内容分析 → 结构化数据提取 → 用户确认 → 数据导入
```

#### 2.4.2 解析结果处理
**功能描述**：处理AI解析结果并转换为数据模型

**核心功能**：
- 解析结果预览
- 结构冲突检测
- 数据类型映射
- 批量导入确认
- 错误处理和重试

### 2.5 版本控制功能

#### 2.5.1 变更历史记录
**功能描述**：跟踪数据模型的所有变更操作

**记录内容**：
- 表结构变更
- 字段修改记录
- 索引变更日志
- 关系调整历史
- 操作人员信息
- 变更时间戳

#### 2.5.2 版本对比功能
**功能描述**：对比不同版本间的差异

**对比维度**：
- 表结构差异
- 字段变更对比
- 索引差异分析
- 关系变更检查
- 影响范围评估

### 2.6 团队协作功能

#### 2.6.1 权限管理
**功能描述**：管理团队成员的操作权限

**权限级别**：
- 查看权限：只能查看数据模型
- 编辑权限：可以修改表结构
- 管理权限：可以删除表和管理权限
- 超级管理员：拥有所有权限

#### 2.6.2 协作机制
**功能描述**：支持多人协作的数据模型设计

**核心功能**：
- 实时协作编辑
- 变更通知机制
- 冲突解决策略
- 评论和讨论
- 审核工作流程

## 3. 用户界面设计

### 3.1 主界面布局

#### 3.1.1 数据模型概览页
```
┌─────────────────────────────────────────────────────────────────┐
│ DevAPI Manager - 数据模型管理                                    │
├─────────────────────────────────────────────────────────────────┤
│ 项目: [电商系统] | 数据库: MySQL 8.0 | 表数量: 15 | 最后更新: 2小时前 │
├─────────────────────────────────────────────────────────────────┤
│ [🔍 搜索表名...] [分类筛选 ▼] [状态筛选 ▼] [+ 新建表] [📁 导入文档] │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │
│ │📊 用户表     │ │🛒 订单表     │ │📦 商品表     │ │💰 支付表     │  │
│ │user_accounts│ │orders       │ │products     │ │payments     │  │
│ │● 已创建      │ │● 已创建      │ │🟡 草稿       │ │● 已创建      │  │
│ │12字段 3索引  │ │8字段 5索引   │ │15字段 2索引  │ │6字段 2索引   │  │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.1.2 数据表详情页
```
┌─────────────────────────────────────────────────────────────────┐
│ 用户账户表 (user_accounts) | ● 已创建 | [编辑] [删除] [导出SQL] [✕] │
├─────────────────────────────────────────────────────────────────┤
│ [📋 表信息] [📊 字段结构] [🔗 索引信息] [🔄 关联关系] [💾 SQL语句]   │
├─────────────────────────────────────────────────────────────────┤
│                           字段结构管理                           │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ [🔍 搜索字段...] [类型筛选 ▼] [+ 添加字段]                  │ │
│ └─────────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │字段列表和编辑区域                                           │ │
│ │                                                           │ │
│ └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│ 说明: 存储用户账户的基础信息，包括登录凭据和基本资料              │ │
│                                                      [关闭]    │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 交互设计规范

#### 3.2.1 操作反馈
- **成功操作**：绿色提示信息，自动消失
- **错误操作**：红色错误信息，需用户手动关闭
- **警告信息**：橙色警告提示，需用户确认
- **加载状态**：展示进度条或加载动画

#### 3.2.2 快捷操作
- **快速搜索**：支持模糊搜索和筛选
- **批量操作**：支持多选和批量处理
- **拖拽排序**：字段顺序调整
- **右键菜单**：常用操作快速入口

## 4. 技术实现方案

### 4.1 前端技术方案

#### 4.1.1 组件架构
```
components/
├── DataModelManager/           # 数据模型管理主组件
│   ├── TableList.tsx          # 表列表组件
│   ├── TableCard.tsx          # 表卡片组件
│   ├── TableModal.tsx         # 表详情弹窗
│   ├── FieldEditor.tsx        # 字段编辑器
│   ├── IndexManager.tsx       # 索引管理器
│   ├── RelationshipViewer.tsx # 关系查看器
│   └── SQLGenerator.tsx       # SQL生成器
├── ImportWizard/              # 导入向导组件
│   ├── FileUpload.tsx         # 文件上传
│   ├── AIParser.tsx           # AI解析组件
│   ├── ResultPreview.tsx      # 解析结果预览
│   └── ImportConfirm.tsx      # 导入确认
└── Common/                    # 通用组件
    ├── SearchBar.tsx          # 搜索栏
    ├── FilterPanel.tsx        # 筛选面板
    ├── LoadingSpinner.tsx     # 加载动画
    └── ConfirmDialog.tsx      # 确认对话框
```

#### 4.1.2 状态管理
```typescript
// 使用Zustand进行状态管理
interface DataModelStore {
  // 表列表状态
  tables: DatabaseTable[]
  selectedTable: DatabaseTable | null
  
  // UI状态
  isLoading: boolean
  activeTab: 'fields' | 'indexes' | 'relationships' | 'sql'
  searchQuery: string
  filters: ModelFilters
  
  // 操作方法
  loadTables: () => Promise<void>
  selectTable: (table: DatabaseTable) => void
  createTable: (table: CreateTableData) => Promise<void>
  updateTable: (id: string, data: UpdateTableData) => Promise<void>
  deleteTable: (id: string) => Promise<void>
  
  // 字段操作
  createField: (tableId: string, field: CreateFieldData) => Promise<void>
  updateField: (fieldId: string, data: UpdateFieldData) => Promise<void>
  deleteField: (fieldId: string) => Promise<void>
}
```

#### 4.1.3 API集成
```typescript
// API服务封装
class DataModelService {
  // 表操作
  async getTables(projectId: string, filters?: ModelFilters): Promise<DatabaseTable[]>
  async getTable(id: string): Promise<DatabaseTable>
  async createTable(data: CreateTableData): Promise<DatabaseTable>
  async updateTable(id: string, data: UpdateTableData): Promise<DatabaseTable>
  async deleteTable(id: string): Promise<void>
  
  // 批量操作
  async createBatchTables(tables: CreateTableData[]): Promise<BatchResult>
  async exportSQL(tableIds: string[]): Promise<string>
  
  // AI解析
  async parseDocument(file: File, options: ParseOptions): Promise<ParseResult>
  async confirmImport(parseResult: ParseResult): Promise<ImportResult>
}
```

### 4.2 后端技术方案

#### 4.2.1 数据库模型设计
```prisma
// Prisma模型定义
model DatabaseTable {
  id            String   @id @default(uuid())
  projectId     String
  name          String
  displayName   String?
  comment       String?
  engine        String   @default("InnoDB")
  charset       String   @default("utf8mb4")
  collation     String   @default("utf8mb4_unicode_ci")
  status        String   @default("DRAFT")
  category      String?
  version       Int      @default(1)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // 关联关系
  project       Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  fields        DatabaseField[]   @relation("TableFields")
  indexes       DatabaseIndex[]
  statistics    TableStatistics?
  fromRelations TableRelationship[] @relation("FromTable")
  toRelations   TableRelationship[] @relation("ToTable")
  
  @@unique([name, projectId])
  @@map("database_tables")
}
```

#### 4.2.2 业务逻辑层
```typescript
// 业务服务类
class DataModelService {
  // 表管理
  async createTable(data: CreateTableInput): Promise<DatabaseTable> {
    // 1. 验证表名唯一性
    // 2. 创建表记录
    // 3. 创建字段记录
    // 4. 创建索引记录
    // 5. 更新统计信息
    // 6. 记录操作日志
  }
  
  async updateTable(id: string, data: UpdateTableInput): Promise<DatabaseTable> {
    // 1. 检查表是否存在
    // 2. 验证变更合法性
    // 3. 执行结构变更
    // 4. 更新版本号
    // 5. 记录变更历史
  }
  
  // SQL生成
  async generateCreateSQL(tableId: string): Promise<string> {
    // 1. 加载表结构
    // 2. 生成字段定义
    // 3. 生成索引定义
    // 4. 生成约束定义
    // 5. 格式化SQL语句
  }
  
  // AI解析
  async parseDocumentWithAI(content: string, type: DocumentType): Promise<ParsedModel> {
    // 1. 调用AI服务
    // 2. 解析返回结果
    // 3. 验证数据完整性
    // 4. 转换为标准格式
  }
}
```

#### 4.2.3 API路由设计
```typescript
// REST API路由
app.use('/api/v1/data-models', dataModelsRouter)

// 路由定义
router.get('/', getTables)              // 获取表列表
router.post('/', createTable)          // 创建新表
router.get('/:id', getTable)           // 获取表详情
router.put('/:id', updateTable)        // 更新表信息
router.delete('/:id', deleteTable)     // 删除表
router.post('/batch', createBatchTables) // 批量创建
router.post('/:id/fields', createField) // 添加字段
router.post('/:id/sql', generateSQL)    // 生成SQL
router.post('/parse', parseDocument)    // AI解析文档
```

### 4.3 AI集成方案

#### 4.3.1 AI服务适配器
```typescript
// AI服务接口
interface AIService {
  parseDocument(content: string, type: DocumentType): Promise<ParsedModel>
  generateSQL(model: DataModel): Promise<string>
  optimizeSchema(schema: TableSchema): Promise<OptimizationSuggestions>
}

// 具体实现
class OllamaService implements AIService {
  async parseDocument(content: string, type: DocumentType): Promise<ParsedModel> {
    const prompt = this.buildParsePrompt(content, type)
    const response = await this.callOllama(prompt)
    return this.parseResponse(response)
  }
}

class OpenAIService implements AIService {
  // OpenAI实现
}
```

#### 4.3.2 提示词工程
```typescript
// 文档解析提示词模板
const PARSE_DOCUMENT_PROMPT = `
你是一个数据库设计专家，请分析以下${documentType}内容，提取数据表结构信息。

输入内容：
${documentContent}

请按照以下JSON格式返回解析结果：
{
  "tables": [
    {
      "name": "表名",
      "displayName": "中文表名",
      "comment": "表说明",
      "fields": [
        {
          "name": "字段名",
          "type": "数据类型",
          "length": "长度(可选)",
          "nullable": false,
          "defaultValue": "默认值(可选)",
          "comment": "字段说明",
          "isPrimaryKey": false,
          "isAutoIncrement": false
        }
      ],
      "indexes": [
        {
          "name": "索引名",
          "type": "索引类型",
          "fields": ["字段名"],
          "isUnique": false
        }
      ]
    }
  ]
}
`
```

## 5. 质量保证

### 5.1 测试策略

#### 5.1.1 单元测试
- 组件渲染测试
- 业务逻辑测试
- API接口测试
- 数据库操作测试

#### 5.1.2 集成测试
- 前后端集成测试
- AI服务集成测试
- 数据库迁移测试
- 批量操作测试

#### 5.1.3 端到端测试
- 完整业务流程测试
- 用户交互测试
- 跨浏览器兼容性测试
- 性能压力测试

### 5.2 性能优化

#### 5.2.1 前端优化
- 组件懒加载
- 虚拟滚动
- 防抖搜索
- 缓存机制

#### 5.2.2 后端优化
- 数据库查询优化
- 缓存策略
- 批量操作优化
- 异步处理

## 6. 部署和维护

### 6.1 部署方案
- Docker容器化部署
- CI/CD自动化流水线
- 多环境配置管理
- 监控和日志收集

### 6.2 维护计划
- 定期数据备份
- 性能监控和优化
- 安全漏洞修复
- 功能迭代升级

## 7. 总结

数据模型功能作为DevAPI Manager的核心模块，通过完善的设计和实现，将为开发者提供强大而易用的数据库结构管理工具。结合AI技术的智能化解析能力，以及完整的团队协作机制，将大大提升数据库设计和管理的效率。

---

**文档版本**: v1.0  
**创建时间**: 2025-01-15  
**最后更新**: 2025-01-15  
**维护人员**: DevAPI团队