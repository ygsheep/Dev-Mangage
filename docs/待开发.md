# 待开发功能清单

## 硬编码接口需要重构

### 1. Features 功能模块接口 (`src/routes/features.ts`)

**完全硬编码的模拟接口，需要连接真实数据库：**

#### 接口清单
- `GET /:projectId/modules` - 获取项目功能模块
- `GET /:projectId/modules/:moduleId` - 获取功能模块详情
- `POST /:projectId/modules` - 创建功能模块
- `PUT /:projectId/modules/:moduleId` - 更新功能模块
- `DELETE /:projectId/modules/:moduleId` - 删除功能模块
- `GET /:projectId/modules/stats` - 获取功能模块统计

#### 当前硬编码数据
```javascript
// 硬编码返回5个功能模块：
- 用户管理 (completed)
- 权限管理 (in-progress) 
- 文件管理 (planned)
- 消息通知 (planned)
- 数据导出 (completed)

// 硬编码统计数据：
{
  totalModules: 5,
  completedModules: 2,
  inProgressModules: 1,
  plannedModules: 2,
  totalApis: 12,
  completionRate: 40,
  categories: {
    '用户系统': 2,
    '权限系统': 1,
    '文件系统': 1,
    '消息系统': 1
  }
}
```

#### 数据库表状态
❌ **无对应数据表**
- 当前 `schema.prisma` 中没有 ProjectModule 或 FeatureModule 表
- 需要创建新表：`project_modules`, `module_apis` 连接到现有 API 表

#### 需要实现
1. **数据库表设计**: 创建 `ProjectModule` 表存储功能模块信息
2. **真实CRUD操作**: 替换硬编码数据为数据库操作
3. **统计计算**: 基于数据库数据动态计算统计信息
4. **API关联**: 将功能模块与现有 `API` 表关联

### 2. Table Statistics 表统计接口 (`src/routes/tableStatistics.ts`)

**生成模拟统计数据，需要连接真实数据库分析：**

#### 接口清单
- `POST /table/:tableId/analyze` - 分析单个表统计信息 (行540)
- `POST /project/:projectId/analyze-all` - 批量分析项目表统计 (行622)
- `GET /` - 获取表统计信息列表
- `GET /:id` - 获取单个表统计详情
- `POST /` - 创建或更新表统计
- `PUT /:id` - 更新表统计
- `DELETE /:id` - 删除表统计
- `GET /project/:projectId/summary` - 获取项目统计汇总

#### 当前硬编码数据
```javascript
// 模拟分析结果（行560-566）：
const mockAnalysis = {
  rowCount: Math.floor(Math.random() * 100000) + 1000,
  dataSize: Math.floor(Math.random() * 50000000) + 100000, // bytes
  indexSize: Math.floor(Math.random() * 10000000) + 50000, // bytes
  fragmentSize: Math.floor(Math.random() * 1000000), // bytes
  lastAnalyzed: new Date()
}
```

#### 数据库表状态
✅ **存在对应数据表**
- 表：`TableStatistics` (在 schema.prisma:295-311 定义)
- 字段：`id`, `tableId`, `rowCount`, `dataSize`, `indexSize`, `fragmentSize`, `lastAnalyzed`
- 关系：连接到 `DatabaseTable` 表
- 查询功能：已实现完整的CRUD操作和汇总统计

#### 需要实现
1. **真实数据库连接**: 替换随机数生成，连接到实际的数据库实例进行分析
2. **统计查询**: 实现真实的表分析SQL查询 (如 `SHOW TABLE STATUS`, `INFORMATION_SCHEMA` 查询)
3. **多数据库支持**: 支持 MySQL、PostgreSQL、SQLite 等不同数据库的统计查询
4. **异步处理**: 大表分析使用后台任务处理，避免HTTP请求超时

### 3. Model Versions 模型版本接口 (`src/routes/modelVersions.ts`)

**已修复类型问题，但差异检测算法仍需增强：**

#### 当前实现状态
- ✅ 已修复类型推断问题 (使用 `table as any` 处理 Map 迭代)
- ✅ 基础版本比较功能已实现
- ⚠️ 差异检测算法较为简化

#### 差异检测算法局限性
- 当前主要基于字段数量比较
- 缺少详细的字段类型变更检测
- 缺少索引变更检测
- 缺少关系变更检测
- 缺少字段属性变更检测（长度、默认值、约束等）

#### 数据库表状态
✅ **存在对应数据表**
- 表：`ModelVersion` (在 schema.prisma:314-338 定义)
- 字段：`id`, `projectId`, `versionNumber`, `changeDescription`, `schemaSnapshot` 等
- 关系：连接到 `Project`，支持版本树结构 (`parentVersionId`, `childVersions`)
- 版本管理：支持分支 (`branchName`) 和激活状态 (`isActive`)

#### 需要增强的功能
1. **详细差异检测**: 字段类型、长度、默认值、约束等详细比较
2. **索引差异分析**: 索引添加、删除、修改检测
3. **关系变更检测**: 外键关系的变更分析
4. **字段级变更**: 字段重命名、类型转换、属性修改
5. **版本合并**: 分支版本的合并策略
6. **回滚功能**: 基于 `schemaSnapshot` 的完整回滚

## 开发优先级

### 高优先级
1. **Table Statistics 真实化**: 这个功能对数据库管理很重要，应该连接真实数据源
2. **Project ID 一致性**: 解决UUID vs 字符串ID的不一致问题

### 中优先级
1. **Features 模块实现**: 如果需要项目管理功能，应该实现真实的数据存储
2. **Model Versions 增强**: 提升版本比较的准确性和完整性

### 低优先级
1. **Features 接口**: 如果只是演示功能，可以保持当前硬编码状态

## 技术债务

### 已修复的编译问题
1. ✅ features.ts - 验证方式统一为 Zod，移除 express-validator
2. ✅ mindmap.ts - JSON 序列化问题，layoutData 存储前使用 `JSON.stringify()`
3. ✅ modelVersions.ts - 类型推断问题，使用 `(table as any)` 修复 Map 迭代
4. ✅ tableStatistics.ts - Prisma upsert 操作改为 findFirst + update/create 模式
5. ✅ AI服务相关文件 - 修复类型定义不匹配，移除不存在的字段
6. ✅ 数据库连接问题 - 修正 DATABASE_URL 路径配置
7. ✅ 项目ID验证 - 统一使用 `z.string().min(1)` 而非 UUID 验证

### 需要关注的设计问题
1. **项目ID格式不一致**: 数据库中存在非UUID格式的项目ID (如 "box-mall-system")
   - 已修复：移除所有路由中的 UUID 验证，统一使用字符串验证
2. **TableStatistics表设计**: 缺少 `tableId` 唯一约束导致可能出现重复记录
   - 建议：添加 `@@unique([tableId])` 约束到 schema
3. **AI服务类型定义**: AI 相关的类型定义已基本完善
   - ✅ 已移除不存在的字段如 `documentType`, `deploymentOrder`
   - ✅ 已修复 `formatStyle` 验证问题

## 建议实现方案

### Table Statistics 真实化实现
```typescript
// 1. 数据库连接配置
interface DatabaseConfig {
  type: 'mysql' | 'postgresql' | 'sqlite'
  host: string
  port: number
  database: string
  // ...
}

// 2. 真实统计查询
class DatabaseAnalyzer {
  async analyzeTable(tableId: string): Promise<TableStats> {
    // 执行真实的数据库分析查询
    // 如：SHOW TABLE STATUS, INFORMATION_SCHEMA查询等
  }
}
```

### Features 模块数据库设计
```sql
-- 功能模块表
CREATE TABLE project_modules (
  id VARCHAR(36) PRIMARY KEY,
  project_id VARCHAR(255) NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  status ENUM('planned', 'in-progress', 'completed') DEFAULT 'planned',
  category VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_project_id (project_id)
);

-- 模块API关联表
CREATE TABLE module_apis (
  module_id VARCHAR(36),
  api_id VARCHAR(36),
  PRIMARY KEY (module_id, api_id)
);
```

## 数据库表分析汇总

| 接口 | 数据库表 | 状态 | 数据来源 | 备注 |
|------|----------|------|----------|------|
| Features 功能模块 | ❌ 无 | 缺失 | 硬编码 | 需要创建 ProjectModule, ModuleAPI 表 |
| Table Statistics 表统计 | ✅ TableStatistics | 存在 | 随机生成 | 表结构完整，但数据是模拟的 |
| Model Versions 模型版本 | ✅ ModelVersion | 存在 | 真实数据 | 表结构完整，差异算法需增强 |
| AI Parsing | ✅ AIParseHistory | 存在 | 真实数据 | AI服务解析历史记录 |
| Mindmap Layout | ✅ MindmapLayout | 存在 | 真实数据 | 思维导图布局存储 |

## 下一步行动

1. **确定开发优先级**: 与产品团队确认哪些功能需要优先实现
2. **数据库设计评审**: 完善相关表结构设计
3. **接口重构计划**: 制定分阶段重构计划
4. **测试策略**: 制定重构后的测试方案

## 推荐的数据库schema修改

### 向Prisma schema添加ProjectModule表
```prisma
model ProjectModule {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String?
  status      String   @default("PLANNED") // PLANNED, IN_PROGRESS, COMPLETED
  category    String?
  progress    Int      @default(0) // 0-100
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关系
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  moduleApis  ModuleAPI[]

  @@index([projectId])
  @@index([status])
  @@map("project_modules")
}

model ModuleAPI {
  moduleId String
  apiId    String

  // 关系
  module   ProjectModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  api      API          @relation(fields: [apiId], references: [id], onDelete: Cascade)

  @@id([moduleId, apiId])
  @@map("module_apis")
}
```

## 实现建议

### Features模块真实化步骤
1. **添加数据库模型**: 在 `schema.prisma` 中添加 ProjectModule 和 ModuleAPI 模型
2. **运行数据库迁移**: `npm run db:push` 更新数据库结构  
3. **重写接口逻辑**: 替换 `features.ts` 中的硬编码数据为真实数据库操作
4. **API关联**: 与现有 `API` 表建立多对多关系
5. **添加种子数据**: 创建初始测试数据用于开发
6. **更新前端**: 确保前端组件能正确处理新的数据结构

### Table Statistics 真实化步骤
1. **创建数据库连接器**: 支持连接外部数据库实例 (MySQL、PostgreSQL、SQLite)
2. **实现统计查询**: 根据不同数据库类型实现相应的分析SQL
   - MySQL: `SHOW TABLE STATUS`, `INFORMATION_SCHEMA.TABLES`
   - PostgreSQL: `pg_stat_user_tables`, `pg_relation_size()`
   - SQLite: `PRAGMA table_info()`, `.stats` 命令
3. **更新接口逻辑**: 替换 `mockAnalysis` 随机数生成为真实查询结果
4. **添加缓存机制**: 避免频繁的数据库分析操作，使用 Redis 或内存缓存
5. **异步处理**: 大表分析使用后台任务处理，提供进度反馈
6. **权限控制**: 安全地连接外部数据库，使用只读权限

## 风险评估

### 高风险
- **Table Statistics**: 连接外部数据库可能带来安全风险，需要严格的权限控制

### 中风险  
- **Features Module**: 数据结构变更可能影响现有前端功能

### 低风险
- **Model Versions**: 算法增强不影响现有数据结构